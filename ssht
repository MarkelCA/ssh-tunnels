#!/bin/bash

declare -A content

open_tunnel() {
    command="ssh -N -L ${content['port_forward']}:${content['host_destination']}:${content['port_destination']} ${content['user_server']}@${content['host_server']} -f -i ${content['ssh_key_path']}"
    echo "Running: $command"
    eval $command
}

read_config() {
    cmd=$1
    database=$2
    file=$3
    while IFS="=" read -r key value; do content["$key"]=$value; done < <(
        yq ".$database | to_entries | map([.key, .value] | join(\"=\")) | .[]" $file
    )

}

close_tunnel() {
    cmd="fuser ${content['port_forward']}/tcp -k"
    echo "Running: $cmd"
    eval $cmd
}

run_command() {
    command=$1
    case $command in
        "open")  open_tunnel  ${@:2} ;;
        "close") close_tunnel  ;;
        *) fail "Error - Unknown awsi command." ;;
    esac
}

main() {
    command=$1
    database=$2
    file=$3
    read_config $command $database $file
    run_command $command
    echo "Finished."
}

main $@
