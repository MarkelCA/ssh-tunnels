#!/bin/bash

DEFAULT_CONFIG_PATH="$HOME/.config/ssht/ssht.yml"

declare -A content

open_tunnel() {
    read_config $command $database $file
    key=""
    if [ -n "${content['ssh_key_path']}" ]; then
        key="-i ${content['ssh_key_path']}"
    fi

    command="ssh -N -L ${content['port_forward']}:${content['host_destination']}:${content['port_destination']} ${content['user_server']}@${content['host_server']} -f $key"
    echo "Running: $command"
    eval $command
}

read_config() {
    cmd=$1
    database=$2
    file=$3
    while IFS="=" read -r key value; do content["$key"]=$value; done < <(
        yq ".tunnels."$database" | to_entries | map([.key, .value] | join(\"=\")) | .[]" $file
    )

}

close_tunnel() {
    read_config $command $database $file
    cmd="fuser ${content['port_forward']}/tcp -k"
    echo "Running: $cmd"
    eval $cmd
}

show() {
    file=$1
    if [ -z "$file" ] ; then
        file=$DEFAULT_CONFIG_PATH
    fi

    yq $file
}

list() {
    file=$1
    if [ -z "$file" ] ; then
        file=$DEFAULT_CONFIG_PATH
    fi

    yq '.tunnels | keys' $file
}

run_command() {
    command=$1
    case $command in
        "open")  open_tunnel  ${@:2} ;;
        "close") close_tunnel  ;;
        "show") show ${@:2} ;;
        "list") list ${@:2} ;;
        *) fail "Error - Unknown awsi command." ;;
    esac
}

main() {
    command=$1
    database=$2
    file=$3

    if [ -z "$file" ] ; then
        file=$DEFAULT_CONFIG_PATH
    fi

    run_command $command $database $file

    echo "Finished."
}

main $@
