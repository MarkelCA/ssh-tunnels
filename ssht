#!/bin/bash

open_tunnel() {
    command="ssh -N -L ${content['port_forward']}:${content['host_destination']}:${content['port_destination']} ${content['user_server']}@${content['host_server']} -f -i ${content['ssh_key_path']}"
    echo "Running: $command"
    eval $command
}

read_config() {
    declare -A content
    database=$1
    file=$2
    while IFS="=" read -r key value; do content["$key"]=$value; done < <(
        yq ".$database | to_entries | map([.key, .value] | join(\"=\")) | .[]" $file
    )
    echo $content;
    open_tunnel $content
}

main() {
    command=$1
    database=$t
    file=$3
    read_config $2 $3
    echo "Finished."
}

main $@
